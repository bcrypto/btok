\section{Общие сведения}\label{CMDS.Intro}

КП и терминал взаимодействуют с КТ с помощью команд APDU (Application
Protocol Data Unit), определенных в~\cite{APDU}. КТ обрабатывает полученную
команду, возвращая ответ. До подачи КТ новой команды должен быть получен
ответ на предыдущую.

Команды и ответы на них содержат обязательные компоненты и дополнительно 
могут содержать необязательные.  

Обязательными компонентами команды являются: CLA~--- класс команды, INS~---
инструкция команды, P1 и P2~--- параметры команды. Обязательными компонентами
ответа являются статусы обработки команды SW1 и SW2.

Необязательным для команды является компонент CDF, который содержит данные 
команды. Если компонент CDF присутствует, то команда должна также содержать 
необязательный компонент Lc, определяющий длину CDF. 

Необязательным для ответа является компонент RDF, который содержит данные 
ответа. Если при выполнении команды ожидается, что в ответе будет 
содержаться компонент RDF, то команда должна содержать необязательный 
компонент Le, определяющий максимально возможную длину компонента RDF в 
ожидаемом ответе.

В~\cite{APDU} определяются соглашения о содержании компонентов команд и
ответов, рассматриваются способы представления компонентов и взаимосвязь
между ними. В частности, согласно~\cite{APDU} CLA определяет,
обрабатывается ли команда как цепочка, используется ли защищенное
соединение и др.

При наличии в команде компонентов Lc и Le они могут быть представлены 
в короткой или расширенной форме. Форма Le должна соответствовать форме Lc. 
%
Короткая и расширенная формы определяются следующим образом: 
\begin{enumerate}
\item[1)]
Lc в короткой форме состоит из одного октета, отличного от $\hex{00}$ и
определяющего значения от~1 до~255;

\item[2)] 
Lc в расширенной форме состоит из трех октетов, при этом первый октет равен
$\hex{00}$, а остальные два октета отличны от $\hex{0000}$ и определяют
значения от~1 до~65535;

\item[3)] 
Le в короткой форме состоит из одного октета, определяющего значения от~1
до~256 (значению 256 соответствует $\hex{00}$);

\item[4)] 
если компонент Lc присутствует в команде, то Le в расширенной форме состоит
из двух октетов, которые определяют значения от~1 до~65536 (значению~65536
соответствует $\hex{0000}$);

\item[5)] 
если компонент Lc отсутствует в команде, то Le в расширенной форме состоит
из трех октетов, при этом первый октет равен $\hex{00}$, а следующие два
октета определяют значения от~1 до~65536 (значению~65536 соответствует
$\hex{0000}$).
\end{enumerate}

В компонентах Lc и Le первый октет представляет старший байт кодируемого числа, 
последний октет~--- младший байт. Другими словами, вместо обычного для 
настоящего стандарта соглашения <<от младших к старшим>> 
(см.~п.~\ref{DEFS.Btoi}) используется соглашение <<от старших к младшим>>  
(big-endian).

В тех случаях, когда можно обойтись короткими формами Lc и Le, 
поддержка расширенных форм со стороны КТ не является обязательной.
КП и терминал должны учитывать это при выборе форм команд в процессе 
взаимодействия с токеном.

В таблице~\ref{Table.CMDS.Fmt} приводится формат пары (команда, ответ) 
с указанием возможных длин компонентов.

\begin{table}[h!]
\caption{Формат пары (команда, ответ)}\label{Table.CMDS.Fmt}
\begin{tabular}{|c|p{10.5cm}|c|}
\hline
Компонент & Описание & Длина в октетах \\
\hline
\hline
CLA & Класс команды & 1 \\
\hline
INS & Инструкция команды & 1 \\
\hline
P1 & Параметр команды & 1 \\
\hline
P2 & Параметр команды & 1 \\
\hline
Lc & Длина данных команды & 0, 1 или 3  \\
\hline
CDF & Данные команды & 0--65535 \\
\hline
Le & Максимально возможная длина данных ответа & 0--3 
\\
\hline
RDF & Данные ответа & 0--65536 \\
\hline
SW1 & Статус ответа & 1 \\
\hline
SW2 & Статус ответа & 1 \\
\hline
\end{tabular}
\end{table}

Данные в компонентах CDF и RDF либо задаются прямо, либо предварительно кодируются. 
При кодировании должны использоваться отличительные правила, определенные в СТБ 34.101.19 
(приложение Б). В настоящем стандарте, если не оговорено противное, используются 
контекстно-зависимые теги, состоящие из одного или двух октетов, а данные 
интерпретируются как строки октетов (см. ГОСТ 34.974) длины не более~65515. 
При кодировании по данным $X\in\{0,1\}^{8*}$ с тегом $T\in\{0,1\}^{8*}$ строится 
строка октетов~$\der(T, X) = T \parallel L \parallel X$, 
где $L\in\{0,1\}^{8*}$~--- кодированная длина $X$ [см. ГОСТ 34.974 (подраздел 
6.3)].  

Если при разборе команды или ответа обнаруживается нарушение их 
формата или формата вложенных кодированных данных, то разбор 
должен быть завершен с ошибкой. 

Команды используются для реализации операций, поддерживаемых КТ.
Минимальный набор операций определяется в~\ref{Oper.Descr}
и кратко описывается в таблице~\ref{Table.Oper.List}. 
%
В таблице для каждой операции указываются состояния КТ, 
в которых операция может выполняться (см. раздел~\ref{STATES}),
и пароли, которые должны использоваться в протоколе BPACE (см.~\ref{OBJ.PWD}).  
%
Символ <</>> в таблице обозначает <<или>>.

Команды могут работать с файловой системой КТ, определенной в 
приложении~\ref{FILES}. Файловая система имеет иерархическую структуру.
Имеются назначенные файлы, которые содержат ссылки на подчиненные файлы,
и элементарные файлы, в которых непосредственно размещаются объекты КТ.
Выделен корневой мастер-файл, которому подчинены (прямо или по цепочке)
все остальные файлы. Прикладным программам eID и eSign соответствуют 
специальные назначенные файлы, непосредственно подчиненные мастер-файлу.

В файловой системе всегда выбран определенный файл. Первоначально это 
мастер-файл. Выбор прикладных программ eID и eSign реализуется 
выбором соответствующих назначенных файлов. 
Набор разрешенных операций определяется в том числе и тем, файл какого уровня
выбран в текущий момент времени: мастер-файл (MF), файл eID или подчиненный 
ему, файл eSign или подчиненный ему. Разрешенные уровни приводятся в последнем 
столбце таблицы~\ref{Table.Oper.List}.

\begin{table}[h!]
\caption{Операции КТ}
\label{Table.Oper.List}
\begin{tabular}{|p{7.5cm}|p{1.3cm}|p{2.6cm}|p{1.8cm}| p{1.7cm}|}
\hline
Операция & Пункт & Состояние и соединение & Пароль BPACE & Уровень \\
\hline
\hline
%1~
Активация личного ключа & \ref{Oper.Descr.ActivateKey} & PS/AS:AT & PIN & eSign\\ 
\hline
%2~
Активация PIN & \ref{Oper.Descr.ActivatePIN} & PS/AS:AT & PUK & eID/eSign\\
\hline
%3~
Выбор мастер-файла & \ref{Oper.Descr.SelectMF} & IS/PS/AS & любой & любой\\
\hline
%4~
Выбор прикладной программы & \ref{Oper.Descr.SelectApp} & PS/AS & любой & любой\\ 
\hline
%5~
Выбор элементарного файла eID & \ref{Oper.Descr.SelectEF} & AS:AT & CAN/PIN & 
eID \\ 
\hline
%6~
Выбор элементарного файла eSign & \ref{Oper.Descr.SelectEF} & PS/AS:AT & PIN & 
eSign \\ 
\hline
%7~
Выполнение основных шагов протокола BAUTH & \ref{Oper.Descr.GABAUTH} & PS & 
любой & MF \\ 
\hline
%8~
Выполнение шагов протокола BPACE & \ref{Oper.Descr.GABPACE} & IS/PS/AS:CP & 
---/любой & MF \\ 
\hline
%9~
Выработка подписи & \ref{Oper.Descr.Signature} & PS/AS:AT & PIN & eSign \\
\hline
%10~
Генерация пары ключей & \ref{Oper.Descr.GenKeys} & PS/AS:AT & PIN & eSign \\
\hline
%11~
Деактивация личного ключа & \ref{Oper.Descr.DeactivateKey}  & PS/AS:AT & PIN & 
eSign\\ 
\hline
%12~
Деактивация PIN & \ref{Oper.Descr.DeactivatePIN}  & PS/AS:AT & PIN/PUK & 
eID/eSign\\ 
\hline
%13~
Изменение PIN & \ref{Oper.Descr.ChangePIN} & PS/AS:CP & PIN & eID/eSign \\
\hline
%14~
Инициализация выработки подписи & \ref{Oper.Descr.SetDST} & PS/AS:AT 
& PIN & eSign \\ 
\hline
%15~
Инициализация разбора токена ключа & \ref{Oper.Descr.SetCT} & 
PS/AS:AT & PIN & eSign \\ 
\hline
%16~
Инициализация протокола BAUTH & \ref{Oper.Descr.SetBAUTH} & PS & любой & MF \\ 
\hline
%17~
Инициализация протокола BPACE & \ref{Oper.Descr.SetBPACE} & IS/PS/AS:CP & 
---/любой & MF \\ 
\hline
%18~
Обновление данных eID & \ref{Oper.Descr.Update} & AS:AT & CAN/PIN & eID \\
\hline
%19~
Обновление данных eSign & \ref{Oper.Descr.Update} & PS/AS:AT & PIN & eSign \\
\hline
%20~
Переключение между соединениями & \ref{Oper.Descr.SetCS} & AS & PIN/PUK & 
eID/eSign \\ 
\hline
%21~
Подтверждение PIN & \ref{Oper.Descr.VerifyPIN} & PS/AS:CP & PIN & eSign \\
\hline
%22~
Проверка дополнительного атрибута& \ref{Oper.Descr.VerifyData}& AS:AT & CAN/PIN 
& eID \\ 
\hline
%23~
Проверка сертификата & \ref{Oper.Descr.VerifyCert} & PS & любой & MF \\
\hline
%24~
Проверка флага подтверждения PIN & \ref{Oper.Descr.VerifyAuth} & PS/AS & PIN 
& eSign \\ 
\hline
%25~
Разблокировка PIN & \ref{Oper.Descr.UnblockPIN} & PS/AS:CP  & PUK & eID/eSign\\ 
\hline
%26~
Разбор токена ключа & 
\ref{Oper.Descr.Decipher} & PS/AS:AT & PIN & eSign \\
\hline
%27~
Сброс флага подтверждения PIN & \ref{Oper.Descr.VerifyDeauth} & 
PS/AS & PIN & eSign \\ 
\hline
%28~
Чтение данных eID & \ref{Oper.Descr.Read} & AS:AT & CAN/PIN & eID \\
\hline
%29~
Чтение данных eSign & \ref{Oper.Descr.Read} & PS/AS:AT& PIN & eSign \\
\hline
%30~
Уничтожение личного ключа & \ref{Oper.Descr.Terminate} & PS/AS:AT  & PIN & eSign \\
\hline
\end{tabular}
\end{table}

Типичные последовательности операций, которые могут выполняться 
с использованием КТ, описываются в~\ref{Oper.Seq}.

В~\ref{CMDS.SM} описывается преобразование команд и ответов из исходной формы в 
защищенную и обратно при использовании защищенного соединения (см.~\ref{CRYPTO.SM}). 


