\section{Описание операций}\label{Oper.Descr}

\subsection{Активация личного ключа}\label{Oper.Descr.ActivateKey}

Для активации личного ключа используется команда <Activate>.
Команда определена в таблице~\ref{Table.Oper.ActivateCmd}.

\begin{table}[h!]
\caption{}\label{Table.Oper.ActivateCmd}
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание\\
\hline
\hline
INS & $\hex{44}$: активация\\
\hline
$\text{P1} \parallel \text{P2}$ & $\hex{2100}$: 
активировать ключ, определяемый CDF\\
\hline
CDF &  $\der(\hex{84}, X)$,   
где $X$ определяет идентификатор личного ключа 
(см. таблицу~\ref{Table.Oper.KeyRef}) \\ 
\hline
\hline
RDF &  --- \\
\hline
$\text{SW1} \parallel \text{SW2}$ & $\hex{9000}$: ключ активирован успешно \\
\cline{2-2}
  & Другое: см. таблицу~\ref{Table.Errors.General} \\
\hline
\end{tabular}
\end{table}

При генерации личного ключа (см.~\ref{Oper.Descr.GenKeys})
он автоматически активируется, и в вызове команды <Activate> нет явной 
необходимости. Вызов может потребоваться после принудительной деактивации ключа 
(см.~\ref{Oper.Descr.DeactivateKey}).

Если ключ уже активирован, то должен быть 
возвращен статус $\text{SW1} \parallel \text{SW2} = \hex{9000}$.

Команда может быть вызвана при выборе eSign в состояниях PS, AS:AT. В состоянии 
AS:AT команда может быть вызвана только авторизованным терминалом, в 
сертификате которого задано право активировать ключи (см.~\ref{DATA.Access}). 

Команда требует предварительной аутентификации по PIN.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Активация PIN}\label{Oper.Descr.ActivatePIN}

Для активации PIN (см.~\ref{OBJ.PWD})  используется команда <Activate>.
Команда определена в таблице~\ref{Table.Oper.ActivatePINCmd}.

\begin{table}[hbt]
\caption{}\label{Table.Oper.ActivatePINCmd}
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание\\
\hline
\hline
INS & $\hex{44}$: активация\\
\hline
P1 & $\hex{10}$: активировать пароль, определяемый P2\\
\hline
P2 & $\hex{03}$: PIN \\
\hline
CDF &  ---  \\
\hline
\hline 
RDF &  --- \\
\hline
$\text{SW1} \parallel \text{SW2}$ & 
  $\hex{9000}$:  PIN активирован успешно\\
\cline{2-2}
  & Другое: см. таблицу~\ref{Table.Errors.General}\\
\hline
\end{tabular}
\end{table}

Первоначально PIN активирован, и в вызове команды <Activate> 
нет явной необходимости. Вызов команды может потребоваться после 
принудительной деактивации PIN (см.~\ref{Oper.Descr.DeactivatePIN}). 

Если PIN уже активирован, то должен быть возвращен 
статус $\text{SW1} \parallel \text{SW2} = \hex{9000}$.

Команда может быть вызвана при выборе eSign 
в состояниях PS, AS:AT и при выборе eID в состоянии 
AS:AT. В состоянии AS:AT команда может быть вызвана 
только авторизованным терминалом, в сертификате которого задано 
право активации пароля PIN (см.~\ref{DATA.Access}).

Команда требует предварительной аутентификации по PUK.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Выбор мастер-файла}
\label{Oper.Descr.SelectMF}

Для выбора мастер-файла используется команда <Select File>. Команда определена в  
таблице~\ref{Table.Oper.SelectMFCmd}. 

\begin{table}[hbt]
\caption{}\label{Table.Oper.SelectMFCmd}
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание \\
\hline
\hline
INS & $\hex{A4}$: выбор файла\\ 
\hline
$\text{P1} \parallel \text{P2}$ & $\hex{0000}$: выбрать мастер-файл\\
\hline
CDF & --- \\
\hline
\hline 
RDF &  --- \\
\hline
$\text{SW1}\parallel\text{SW2}$ & 
$\hex{9000}$: мастер-файл выбран успешно\\
\cline{2-2}
  & Другое: см. таблицу~\ref{Table.Errors.General} \\
\hline
\end{tabular}
\end{table}

Если мастер-файл уже выбран, то должен быть возвращен 
статус $\text{SW1} \parallel \text{SW2} = \hex{9000}$.

Команда может быть вызвана в любом из состояний.

После успешного выполнения команды мастер-файл становится выбранным.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Выбор прикладной программы}
\label{Oper.Descr.SelectApp}

Для выбора прикладной программы используется команда <Select File>. 
Команда определена в таблице~\ref{Table.Oper.SelectAppCmd}.

\begin{table}[hbt]
\caption{}\label{Table.Oper.SelectAppCmd}
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание \\
\hline
\hline
INS & $\hex{A4}$: выбор файла\\ 
\hline
P1 & $\hex{04}$: выбрать прикладную программу\\
\hline
P2 & $\hex{0C}$: не возвращать информацию о файле\\
\hline
CDF & AID прикладной программы (см. приложение~\ref{FILES})\\
\hline 
\hline
RDF &  --- \\
\hline
$\text{SW1}\parallel\text{SW2}$ & 
$\hex{9000}$: прикладная программа выбрана успешно\\
\cline{2-2}
  & $\hex{6A82}$: файл не найден\\
\cline{2-2}
  & Другое: см. таблицу~\ref{Table.Errors.General}\\
\hline
\end{tabular}
\end{table}

Команда может быть вызвана в состояниях PS и AS.

Для выбора прикладной программы eID требуется
предварительная аутентификация по CAN, PIN или PUK.

Для выбора прикладной программы eSign требуется
предварительная аутентификация по PIN или PUK.

Если прикладная программа уже выбрана, то должен быть возвращен
статус $\text{SW1} \parallel \text{SW2} = \hex{9000}$.

После успешного выполнения команды файл прикладной программы 
становится выбранным.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Выбор элементарного файла}
\label{Oper.Descr.SelectEF}

Для выбора элементарного файла используется команда <Select File>. 
Команда определена в таблице~\ref{Table.Oper.SelectEFCmd}.

\begin{table}[hbt]
\caption{}\label{Table.Oper.SelectEFCmd}
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание \\
\hline
\hline
INS & $\hex{A4}$: выбор файла\\ 
\hline
P1 & $\hex{02}$: выбрать элементарный файл для текущей прикладной программы\\
\hline
P2 & $\hex{0C}$: не возвращать информацию о файле\\
\hline
CDF & FID файла для текущей прикладной программы (см. приложение~\ref{FILES})\\
\hline 
\hline
RDF &  --- \\
\hline
$\text{SW1}\parallel\text{SW2}$ & 
$\hex{9000}$: элементарный файл выбран успешно \\
\cline{2-2}
  & $\hex{6A82}$: файл не найден \\
\cline{2-2}
  & Другое: см. таблицу~\ref{Table.Errors.General}\\
\hline
\end{tabular}
\end{table}

Команда может вызываться в состояниях PS, AS:AT 
при выборе eSign и в состоянии AS:AT при выборе eID. 
В состоянии AS:AT команда может вызываться только 
авторизованным терминалом, в сертификате которого
задано право доступа к соответствующему элементарному файлу 
(см.~\ref{DATA.Access}).

Для выбора элементарных файлов прикладной программы eSign 
требуется предварительная аутентификация по PIN.

Для выбора элементарных файлов прикладной программы eID 
требуется предварительная аутентификация по CAN или PIN.

Для выбора элементарных файлов в состоянии AS:AT
требуется взаимная аутентификация КТ и терминала
по протоколу BAUTH (см.~\ref{Oper.Descr.SetBAUTH}).

После успешного выполнения команды элементарный файл становится выбранным.

Элементарные файлы, которые могут быть выбраны, 
приводятся в приложении~\ref{FILES}.  
Выбор элементарного файла может потребоваться для
чтения (см.~\ref{Oper.Descr.Read}) или 
обновления (см.~\ref{Oper.Descr.Update}) данных.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Выполнение основных шагов протокола BAUTH}
\label{Oper.Descr.GABAUTH} 

Для выполнения основных шагов протокола BAUTH используется 
команда <General Authenticate>. 
Команда определена в таблице~\ref{Table.Oper.GABAUTHCmd}.
Должна вызываться цепочка команд <General Authenticate> 
с входными и выходными данными из таблицы~\ref{Table.Oper.BAUTH}, 
которые определяются в соответствии с~\ref{CRYPTO.BAUTH}. 

\begin{table}[H]
\caption{}\label{Table.Oper.GABAUTHCmd}
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & 	Описание \\
\hline
\hline
INS & $\hex{86}$: общая аутентификация\\
\hline
$\text{P1} \parallel \text{P2}$ & $\hex{0000}$: не задавать протокол (уже задан)\\ 
\hline
CDF & Отсутствует или $\der(\hex{7C}, X)$, 
где~$X$~--- сообщение протокола, сформированное терминалом\\
\hline 
\hline
RDF & Отсутствует или $\der(\hex{7C}, Y)$, где~$Y$~--- 
сообщение протокола, сформированное КТ\\
\hline
$\text{SW1} \parallel \text{SW2}$ 
  & $\hex{9000}$: протокол (шаг) выполнен успешно \\
\cline{2-2}
  & Другое: см. таблицу~\ref{Table.Errors.General} \\
\hline
\end{tabular}
\end{table}

\begin{table}[h]
\caption{Данные цепочки команд, реализующих протокол BAUTH}
\label{Table.Oper.BAUTH}
\begin{tabular}{|c|c|c|}
\hline
№ вызова & Данные в команде & Данные в ответе\\
\hline
\hline
1 & --- & $\der(\hex{80}, \text{M1})$\\
\hline
2 & $\der(\hex{81}, \text{M2})$ & 
$\der(\hex{82}, \text{M3})$  \\
\hline
\end{tabular}
\end{table}

При односторонней аутентификации компонент RDF в ответе на 
вторую команду в цепочке не возвращается.

Команда может вызываться при выборе мастер-файла в состоянии PS  
непосредственно после проверки сертификата терминала
(см.~\ref{Oper.Descr.VerifyCert}).

После успешного выполнения протокола BAUTH между КТ и терминалом 
устанавливается защищенное соединение (см.~\ref{CMDS.SM}).

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Выполнение шагов протокола BPACE}
\label{Oper.Descr.GABPACE} 

Для выполнения шагов протокола BPACE используется команда <General 
Authenticate>. 
Команда определена в таблице~\ref{Table.Oper.GABPACECmd}.
Для выполнения шагов протокола BPACE должна вызываться цепочка 
команд <General Authenticate> с входными и выходными данными 
из таблицы~\ref{Table.Oper.BPACE}, 
которые определяются в соответствии с~\ref{CRYPTO.BPACE}.

\begin{table}[H]
\caption{}\label{Table.Oper.GABPACECmd}
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & 	Описание \\
\hline
\hline
INS & $\hex{86}$: общая аутентификация \\
\hline
$\text{P1} \parallel \text{P2}$ & $\hex{0000}$: не задавать протокол (уже задан)\\ 
\hline
CDF & $\der(\hex{7C}, X)$, 
где~$X$~--- сообщение протокола, сформированное КП\\ 
\hline 
\hline
RDF & $\der(\hex{7C}, Y)$, где~$Y$~--- 
сообщение протокола, сформированное КТ\\
\hline
$\text{SW1} \parallel \text{SW2}$ & 
$\hex{9000}$: протокол (шаг) выполнен успешно\\
\cline{2-2}
& $\hex{63CX}$: протокол (шаг) выполнен с ошибкой из-за 
неверного пароля, осталось \texttt{X} попыток аутентификации\\
\cline{2-2}
& $\hex{6983}$: ошибка, пароль заблокирован\\
\cline{2-2}
& $\hex{6984}$: ошибка, пароль деактивирован\\
\cline{2-2}
& $\hex{6985}$: ошибка, пароль приостановлен\\
\cline{2-2}
& Другое: см. таблицу~\ref{Table.Errors.General} \\
\hline
\end{tabular}
\end{table}

Статус $\hex{63CX}$ относится ко всем паролям.
%
Для CAN число \texttt{X} всегда равняется 1.
%
Для PIN значение $\texttt{X}=1$ означает приостановку пароля,
а значение $\texttt{X}=0$~--- его блокировку.
%
Для PUK число \texttt{X} равняется 9.
Исключение составляет случай, когда неверный PUK 
последовательно предъявляется несколько раз при заблокированном PIN.
В этом случае \texttt{X} уменьшается вплоть до 0,
и при достижении нулевого значения PIN блокируется навсегда.

Последние 3 статуса ответа относятся только к паролю PIN.
Статусы означают, что пароль не проверялся из-за нарушения 
требований к его состоянию. При статусах $\hex{6983}$, $\hex{6984}$ для 
разблокировки или активации PIN требуется выполнить BPACE с паролем PUK. При 
статусе $\hex{6985}$ для возобновления PIN требуется выполнить BPACE с паролем CAN. 

\begin{table}[H]
\caption{Данные цепочки команд, реализующих протокол BPACE}
\label{Table.Oper.BPACE}
\begin{tabular}{|c|c|c|}
\hline
№ вызова & Данные в команде & Данные в ответе\\
\hline
\hline
1 & $\der(\hex{80}, \text{M1})$ & 
$\der(\hex{81}, \text{M2})$\\
\hline
2 & $\der(\hex{82}, \text{M3})$ & 
$\der(\hex{83}, \text{M4})$\\
\hline
\end{tabular}
\end{table}

Команда может вызываться при выборе мастер-файла в любом состоянии
непосредственно после инициализации протокола BPACE 
(см.~\ref{Oper.Descr.SetBPACE}). 

При успешном выполнении протокола BPACE с паролем PIN 
устанавливается флаг подтверждения PIN.
При ошибке флаг сбрасывается.

После успешного выполнения протокола BPACE между КТ и КП 
устанавливается защищенное соединение (см.~\ref{CMDS.SM}).

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Выработка подписи}
\label{Oper.Descr.Signature}

Для выработки подписи используется 
команда <PSO: Compute Digital Signature>
(Perform Security Operation: Compute Digital Signature).
Команда определена в таблице~\ref{Table.Oper.SignatureCmd}.

\begin{table}[hbt]
\caption{}\label{Table.Oper.SignatureCmd}
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание\\ 
\hline
\hline
INS & $\hex{2A}$: управление средой безопасности \\
\hline
$\text{P1} \parallel \text{P2}$ & $\hex{9E9A}$: выработать подпись\\ 
\hline
CDF & Хэш-значение подписываемых данных\\
\hline 
\hline
RDF & Электронная цифровая подпись\\
\hline
$\text{SW1} \parallel \text{SW2}$ & 
  $\hex{9000}$: подпись выработана успешно \\
\cline{2-2}
  & Другое: см. таблицу~\ref{Table.Errors.General} \\
\hline
\end{tabular}
\end{table}

В компоненте CDF команды должно передаваться хэш-значение подписываемых данных.
Должен использоваться алгоритм хэширования, заданный при инициализации 
выработки подписи (см.~\ref{Oper.Descr.SetDST}). 
%
На уровне стойкости~$l$ хэш-значение должно состоять из~$2l$ битов.

При выработке подписи используется алгоритм \texttt{bign-sign}
(см.~\ref{CRYPTO.StdAlg}) со стандартными параметрами СТБ 34.101.45.
Эти параметры определяются неявно по уровню стойкости личного ключа,
выбранному при инициализации выработки подписи.
%
На уровне стойкости~$l$ подпись состоит из~$3l$ битов.

Команда может вызываться при выборе eSign в состояниях 
PS и AS:AT непосредственно после инициализации выработки подписи.
%
%В состоянии AS:AT команда может вызываться только авторизованным 
%терминалом с правом выработки подписи (см. \ref{DATA.Access}).

%При вызове команды флаг подтверждения пароля PIN должен быть 
%установлен.
После выполнения $N$ команд флаг подтверждения PIN сбрасывается независимо от 
результатов выполнения команд, где $N$~--- значение, 
задаваемое при инициализации протокола BPACE (см.~\ref{Oper.Descr.SetBPACE}).
%
Для установки флага после сброса необходимо либо подтвердить пароль PIN 
(см.~\ref{Oper.Descr.VerifyPIN}), либо повторно выполнить аутентификацию по PIN 
(см.~\ref{Oper.Seq.BPACE}). 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Генерация пары ключей}\label{Oper.Descr.GenKeys}

Для генерации пары ключей (личного и открытого) прикладной 
программы eSign используется команда <Generate Asymmetric Key Pair>. При 
выполнении команды сгенерированный личный ключ сохраняется в КТ,
а открытый ключ возвращается как данные ответа.
После генерации личный ключ может использоваться 
для выработки подписи (см.~\ref{Oper.Descr.Signature}) и
разбора токена ключа (см.~\ref{Oper.Descr.Decipher}).
Команда определена в таблице~\ref{Table.Oper.GenKeysCmd}.

\begin{table}[hbt]
\caption{}\label{Table.Oper.GenKeysCmd}
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание\\
\hline
\hline
INS & $\hex{46}$: генерация пары ключей\\
\hline
$\text{P1} \parallel\text{P2}$ & $\hex{8000}$:
возвратить открытый ключ \\
\hline
CDF & $\der(\hex{B6},\der(\hex{84}, X))$,
где $X$ определяет идентификатор генерируемого личного ключа
(см. таблицу~\ref{Table.Oper.KeyRef}) \\
\hline 
\hline
RDF & Открытый ключ\\
\hline
$\text{SW1} \parallel \text{SW2}$ & 
$\hex{9000}$: пара ключей сгенерирована успешно\\
\cline{2-2}
  & $\hex{6984}$: ключ уже существует \\
\cline{2-2}
  & Другое: см. таблицу~\ref{Table.Errors.General} \\
\hline
\end{tabular}
\end{table}

Допустимые значения идентификаторов личного ключа определяются
в соответствии с таблицей~\ref{Table.Oper.KeyRef} и зависят от
уровня стойкости личного ключа и состояния КТ:
младшая тетрада идентификатора характеризует уровень стойкости ключа,
а старшая~--- состояние, в котором ключ может использоваться.
%
КТ должен поддерживать генерацию ключей уровня стойкости 
$l=128$ и может поддерживать генерацию ключей 
уровней стойкости $l=192,256$.

\begin{table}[hbt]
\caption{Допустимые значения идентификаторов личного ключа}
\label{Table.Oper.KeyRef}
\begin{tabular}{|c|c|c|c|}
\hline
Уровень стойкости & \multicolumn{2}{|c|}{Значение } & Поддержка\\
\cline{2-3}
ключа & Состояние PS & Состояние AS & \\
\hline
\hline
128 & $\hex{01}$ & $\hex{11}$ & Обязательна \\
192 & $\hex{02}$ & $\hex{12}$ & Необязательна\\
256 & $\hex{03}$ & $\hex{13}$ & Необязательна\\
\hline
\end{tabular}
\end{table}

При генерации ключей используется алгоритм \texttt{bign-sign}
со стандартными параметрами СТБ 34.101.45, 
которые определяются неявно по уровню стойкости личного ключа. 
%
На уровне стойкости~$l$ открытый ключ задается~$4l$ битами
по правилам, установленным в СТБ 34.101.45.

Команда может вызываться при выборе eSign в состояниях 
PS и AS:AT. В состоянии AS:AT команда может вызываться 
только авторизованным терминалом, в сертификате которого задано право
генерации ключей в терминальном режиме (см.~\ref{DATA.Access}).

Команда требует предварительной аутентификации по PIN, 
а также установки флага подтверждения PIN.

Выполнение команды приводит к сбросу флага подтверждения PIN.
Для установки флага после сброса необходимо либо подтвердить пароль PIN 
(см.~\ref{Oper.Descr.VerifyPIN}), либо повторно выполнить аутентификацию по PIN 
(см.~\ref{Oper.Seq.BPACE}). 

Если при выполнении команды личный ключ с указанным в команде идентификатором
уже существует, то должен быть возвращен статус 
$\text{SW1} \parallel \text{SW2} = \hex{6984}$. 
При этом для генерации нового ключа старый ключ должен быть предварительно 
уничтожен командой <Terminate> (см.~\ref{Oper.Descr.Terminate}).

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Деактивация личного ключа}
\label{Oper.Descr.DeactivateKey} 

Для деактивации личного ключа используется команда <Deactivate>.
Команда определена в таблице~\ref{Table.Oper.DeactivateKeyCmd}.

\begin{table}[hbt]
\caption{}\label{Table.Oper.DeactivateKeyCmd}
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание\\
\hline
\hline
INS & $\hex{04}$: деактивация\\
\hline
$\text{P1} \parallel \text{P2}$ & $\hex{2100}$: 
деактивировать ключ, определяемый CDF\\
\hline
CDF &  $\der(\hex{84}, X)$,   
где $X$ определяет идентификатор личного ключа 
(см. таблицу~\ref{Table.Oper.KeyRef})\\
\hline 
\hline
RDF & --- \\
\hline
$\text{SW1} \parallel \text{SW2}$ & 
$\hex{9000}$: ключ деактивирован успешно \\
\cline{2-2}
  & Другое: см. таблицу~\ref{Table.Errors.General} \\
\hline
\end{tabular}
\end{table}

Команда может вызываться при выборе eSign в состояниях 
PS и AS:AT. В состоянии AS:AT команда может вызываться 
только авторизованным терминалом, в сертификате которого задано право
деактивировать ключи (см.~\ref{DATA.Access}).

Команда требует предварительной аутентификации по PIN. 

Если ключ уже деактивирован, то должен быть возвращен статус
$\text{SW1} \parallel \text{SW2} = \hex{9000}$.

После деактивации личного ключа выполнение любых операций, 
требующих его использования, становится невозможным.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Деактивация PIN}
\label{Oper.Descr.DeactivatePIN} 

Для деактивации PIN (см.~\ref{OBJ.PWD}) используется команда <Deactivate>.
Команда определена в таблице~\ref{Table.Oper.DeactivatePINCmd}.

\begin{table}[hbt]
\caption{}\label{Table.Oper.DeactivatePINCmd}
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание \\
\hline
\hline
INS & $\hex{04}$: деактивация\\
\hline
P1 & $\hex{10}$: деактивировать пароль, определяемый P2\\
\hline
P2 & $\hex{03}$: PIN \\
\hline
CDF &  --- \\
\hline 
\hline
RDF & --- \\
\hline
$\text{SW1} \parallel \text{SW2}$ & 
$\hex{9000}$: PIN деактивирован успешно\\
\cline{2-2}
  & Другое: см. таблицу~\ref{Table.Errors.General}\\
\hline
\end{tabular}
\end{table}

Команда может вызываться при выборе eSign в состояниях 
PS, AS:AT и при выборе eID в состоянии AS:AT. 
В состоянии AS:AT команда может вызываться только авторизованным терминалом, 
в сертификате которого задано право деактивировать пароль PIN
(см.~\ref{DATA.Access}).

Команда требует предварительной аутентификации по PIN или PUK. 

Если PIN уже деактивирован, то должен быть возвращен 
статус $\text{SW1} \parallel \text{SW2} = \hex{9000}$.

После деактивации PIN выполнение любых операций, 
требующих аутентификации по паролю PIN (см. таблицу~\ref{Table.Oper.List}), 
становится невозможным. При этом КТ переходит в состояние IS и мастер-файл 
становится выбранным файлом. 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Изменение PIN}
\label{Oper.Descr.ChangePIN}

Для изменения PIN используется команда <Change reference data>.
Команда определена в таблице~\ref{Table.Oper.ChangePINCmd}.

\begin{table}[hbt]
\caption{}\label{Table.Oper.ChangePINCmd}
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & 	Описание \\
\hline
\hline
INS & $\hex{24}$: изменение данные\\
\hline
P1 & $\hex{00}$: задать старое и новое значения пароля\\
\hline
P2 & $\hex{03}$: PIN \\
\hline
CDF & Старое и новое значения PIN ($6 + 6$ октетов)\\ 
\hline 
\hline
RDF & 	 --- \\
\hline
$\text{SW1}\parallel\text{SW2}$ & 
 $\hex{9000}$: PIN изменен успешно \\
\cline{2-2}
  & Другое: см. таблицу~\ref{Table.Errors.General}\\
\hline
\end{tabular}
\end{table}

Команда может вызываться при выборе eSign в состояниях 
PS, AS:CP и при выборе eID в состоянии AS:CP. 
В состоянии AS:CP команда может вызываться только в случае, 
если в сертификате  авторизованного терминала задано 
право изменения пароля PIN (см.~\ref{DATA.Access}).

Команда требует предварительной аутентификации по PIN. 

Выполнение команды приводит к сбросу флага подтверждения PIN.
Для установки флага после сброса необходимо либо подтвердить пароль PIN 
(см.~\ref{Oper.Descr.VerifyPIN}), либо повторно выполнить аутентификацию по PIN 
(см.~\ref{Oper.Seq.BPACE}). 


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Инициализация выработки подписи}
\label{Oper.Descr.SetDST}

Для инициализации выработки подписи используется команда     
<MSE: Set DST> (Manage Security Environment: Set Digital Signature Template). 
Команда задает личный ключ и алгоритм хэширования, которые будут использоваться 
при выработке подписи.
%
Команда определена в таблице~\ref{Table.Oper.SetDSTCmd}.

\begin{table}[hbt]
\caption{}\label{Table.Oper.SetDSTCmd}
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание \\
\hline
\hline
INS & $\hex{22}$: управление средой безопасности\\ 
\hline
$\text{P1} \parallel\text{P2}$ & $\hex{41B6}$: 
инициализировать алгоритм выработки подписи \\
\hline
CDF & 
$\der(\hex{84}, X) \parallel \der(\hex{80}, Y)$, 
где $X$ определяет идентификатор личного ключа (см. таблицу~\ref{Table.Oper.KeyRef}), 
а $Y$~--- идентификатор используемого при выработке подписи алгоритма 
хэширования и принимает значение $\hex{90}$ для алгоритма хэширования 
\texttt{belt-hash}, $\hex{B0}$ для алгоритма хэширования \texttt{bash384} и 
$\hex{C0}$ для алгоритма хэширования \texttt{bash512} (см.~\ref{CRYPTO.StdAlg})\\
\hline 
\hline
RDF &  --- \\
\hline
$\text{SW1} \parallel \text{SW2}$ & 
$\hex{9000}$: алгоритм инициализирован успешно \\
\cline{2-2}
  & $\hex{6283}$: личный ключ деактивирован \\
\cline{2-2}
  & $\hex{6984}$: личный ключ уничтожен \\
\cline{2-2}
  & Другое: см. таблицу~\ref{Table.Errors.General} \\
\hline
\end{tabular}
\end{table}

В компоненте CDF алгоритм хэширования \texttt{belt-hash}
может быть задан только совместно с личным ключом 
уровня стойкости $l=128$,
а алгоритмы хэширования \texttt{bash384} и \texttt{bash512}~--- 
с личными ключами уровней стойкости $l=192$ или $l=256$
соответственно.
Уровень стойкости алгоритма хэширования \texttt{bash} определяется 
неявно по уровню стойкости выбранного личного ключа.

Команда требует предварительной аутентификации по PIN,
а также установки флага подтверждения PIN. Для установки флага, 
если он был сброшен, необходимо либо подтвердить пароль PIN 
(см.~\ref{Oper.Descr.VerifyPIN}), либо повторно выполнить аутентификацию по 
паролю PIN (см.~\ref{Oper.Seq.BPACE}). 

Команда может вызываться при выборе eSign в состояниях PS и AS:AT. В состоянии 
AS:AT команда может вызываться только авторизованным терминалом,
в сертификате которого задано право выработки подписи в терминальном режиме 
(см.~\ref{DATA.Access}). 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Инициализация разбора токена ключа}
\label{Oper.Descr.SetCT}

Для инициализации разбора токена ключа
используется команда <MSE: Set CT> 
(Manage Security Environment: Set Confidentialy template).
%
Команда задает личный ключ, который будет использоваться при разборе токена 
ключа. Команда определена в таблице~\ref{Table.Oper.SetCTCmd}.

\begin{table}[hbt]
\caption{}\label{Table.Oper.SetCTCmd}
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание \\
\hline
\hline
INS & $\hex{22}$: управление средой безопасности\\ 
\hline
$\text{P1} \parallel\text{P2}$ & $\hex{41B8}$: 
инициализировать алгоритм разбора токена ключа
(расшифрования ключа) \\
\hline
CDF & 
$\der(\hex{84}, X)$, 
где $X$ определяет идентификатор личного ключа
(см. таблицу~\ref{Table.Oper.KeyRef})\\
\hline
\hline
RDF &  --- \\
\hline
$\text{SW1} \parallel \text{SW2}$ & 
$\hex{9000}$: алгоритм инициализирован успешно \\
\cline{2-2}
  & $\hex{6283}$: личный ключ деактивирован \\
\cline{2-2}
  & $\hex{6984}$: личный ключ уничтожен \\
\cline{2-2}
  & Другое: см. таблицу~\ref{Table.Errors.General} \\
\hline
\end{tabular}
\end{table}

Команда может вызываться при выборе eSign в состояниях PS и AS:AT. В состоянии 
AS:AT команда может вызываться только авторизованным терминалом, в сертификате 
которого задано право разбора токена ключа в терминальном режиме 
(см.~\ref{DATA.Access}). 

Команда требует предварительной аутентификации по PIN. 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Инициализация протокола BAUTH}
\label{Oper.Descr.SetBAUTH}

Для инициализации протокола BAUTH используется команда <MSE: Set AT> 
(Manage Security Environment: Set Authentication Template).
Команда определена в таблице~\ref{Table.Oper.SetBAUTHCmd}.

\begin{table}[hbt]
\caption{}\label{Table.Oper.SetBAUTHCmd}
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание \\
\hline
\hline
INS & $\hex{22}$: управление средой безопасности\\ 
\hline
$\text{P1} \parallel\text{P2}$ & $\hex{F1A4}$: выбрать и 
инициализировать протокол BAUTH с взаимной 
аутентификацией \\ 
\cline{2-2}
 & $\hex{B1A4}$: выбрать и инициализировать протокол BAUTH с 
односторонней аутентификацией\\
\hline
CDF & Объект данных 
$\der(\hex{80}, X)$, где~$X$~--- 
закодированный объектный идентификатор (без поля тега и поля 
длины) протокола (см. приложение~\ref{ASN}).\\
 & Объект данных $\der(\hex{85}, X)$, 
где~$X$ определяет хэш-значение запроса аутентификации (см. раздел~\ref{FLOW}).\\
 & Объект данных~$X$, который является 
закодированным значением типа \verb|AuthAuxData| (см.~\ref{DATA.Optional}). 
Используется в команде <Verify> (см.~\ref{Oper.Descr.VerifyData}) 
для получения значений дополнительных атрибутов DocumentValidity, 
AgeVerification, RegionVerification. В~$X$ 
обязательно должны быть включены параметры атрибута DocumentValidity.\\
\hline 
\hline
RDF &  --- \\
\hline
$\text{SW1} \parallel \text{SW2}$ 
  & $\hex{9000}$: протокол инициализирован успешно \\
\cline{2-2}
  & Другое: см. таблицу~\ref{Table.Errors.General}\\
\hline
\end{tabular}
\end{table}

В компоненте CDF \addendum{обязательным является только первый объект.
Объекты} должны передаваться с помощью одной команды, т.~е. использование
цепочки команд <MSE: Set AT> не допускается.

Команда может вызываться при выборе мастер-файла в состоянии PS 
непосредственно после выполнения протокола BPACE 
(см.~\ref{Oper.Descr.GABPACE}). 
%
\addendum{
Приветственное сообщение $\hello_\text{Т}$ протокола BAUTH определяется как 
$\text{CDF}\parallel\texttt{CertHAT}^*$. Здесь~$\texttt{CertHAT}^*$~--- 
список объектов $\texttt{CertHAT}$, указанный ранее в команде инициализации 
протокола BPACE (см.~\ref{Oper.Descr.SetBPACE}). 
%
Приветственное сообщение $\hello_\text{КТ}$ протокола BAUTH полагается пустым.
}

При успешном выполнении протокола BAUTH дата, которая передается в команде 
для проверки срока действия КТ, может использоваться для обновления 
даты, которая хранится на КТ (см.~\ref{OBJ.Date}). 

\subsection{Инициализация протокола BPACE}
\label{Oper.Descr.SetBPACE}

Для инициализации протокола BPACE используется команда
<MSE: Set AT> (Manage Security Environment: Set Authentication Template). 
%
Команда определена в таблице~\ref{Table.Oper.SetBPACECmd}. 

\begin{table}[h!]
\caption{}\label{Table.Oper.SetBPACECmd}
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание \\
\hline
\hline
INS & $\hex{22}$: управление средой безопасности\\ 
\hline
$\text{P1} \parallel\text{P2}$ & $\hex{C1A4}$: выбрать и 
инициализировать протокол BPACE\\ 
\hline
CDF & Обязательный объект данных 
$\der(\hex{80}, X)$, где~$X$~--- 
закодированный объектный идентификатор (без поля тега и поля 
длины) протокола (см. приложение~\ref{ASN}).\\
& Обязательный объект данных $\der(\hex{83}, X)$, 
где $X$ определяет, какой пароль будет использоваться в протоколе: 
$\hex{02}$~--- CAN,  $\hex{03}$~--- PIN, 
$\hex{04}$~--- PUK.\\
& 
Необязательные объекты данных типа \texttt{CertHAT} (см.~\ref{DATA.Access}). 
Используются для установки прав доступа к данным и сервисам 
прикладных программ КТ. 
Для каждой прикладной программы используется свой объект.
Отсутствие объекта для определенной прикладной
программы означает отсутствие прав доступа к ней.\\
 & Необязательный объект данных $\der(\hex{53}, X)$, 
где $X$ принимает значения от $\hex{00}$ до~$\hex{FF}$.
Октет~$X$ кодирует число~$N$ последовательных подписей,  
которые могут быть выработаны прикладной программой eSign
без повторного подтверждения PIN.
%
Значение~$N=0$ означает, что может быть выработано 
неограниченное количество подписей. 
%
Если объект $\der(\hex{53}, X)$ не задан, то eSign 
использует $N=1$\\
\hline 
\hline
RDF &  --- \\
\hline
$\text{SW1} \parallel \text{SW2}$ & 
$\hex{9000}$: протокол инициализирован успешно,
число возможных попыток аутентификации равно максимальному значению\\
\cline{2-2}
& $\hex{63CX}$: протокол инициализирован успешно,
осталось \texttt{X} попыток аутентификации и число попыток меньше максимального\\
\cline{2-2}
& $\hex{6983}$: ошибка, пароль заблокирован\\
\cline{2-2}
& $\hex{6984}$: ошибка, пароль деактивирован\\
\cline{2-2}
& $\hex{6985}$: ошибка, пароль приостановлен\\
\cline{2-2}
& Другое: см. таблицу~\ref{Table.Errors.General}\\
\hline
\end{tabular}
\end{table}

Тип пароля, который должен использоваться при 
инициализации BPACE для выполнения тех или иных
операций, определяется в таблице~\ref{Table.Oper.List}.

Последние 4 статуса ответа (кроме $\hex{9000}$) относятся только к паролю PIN.
При статусах $\hex{6983}$, $\hex{6984}$ для разблокировки или активации PIN 
требуется выполнить BPACE с паролем PUK. При статусе $\hex{6985}$ для 
возобновления PIN требуется выполнить BPACE с паролем CAN.

Все объекты данных, которые требуется передать через команду <MSE: Set AT>,
должны укладыватся в один компонент CDF и передаваться за один вызов команды.
Другими словами, использование цепочки команд <MSE: Set AT> не допускается. 
При этом порядок следования объектов данных в CDF не важен. 
Например, для протокола BPACE, использующего PIN, компонент CDF, 
содержащий только обязательные объекты данных, может иметь вид: 
$\text{CDF} = \der(\hex{83},\hex{03}) \parallel \der(\hex{80}, X)$. 
Здесь~$X$~--- закодированный (без поля тега и поля длины) объектный 
идентификатор протокола BPACE (см. СТБ 34.101.66).

\addendum{
Компонент CDF должен использоваться в протоколе BPACE в качестве 
приветственного сообщения $\hello_\text{КП}$ (см.~\ref{CRYPTO.BPACE}).
}
 
Команда может вызываться в любом из состояний при выборе мастер-файла.

При успешном выполнении команды защищенное соединение <<терминал~--- КТ>>,
если оно было установлено ранее, закрывается.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Обновление данных}
\label{Oper.Descr.Update}

Для обновления данных элементарных файлов используется команда <Update Binary>.
Команда определена в таблице~\ref{Table.Oper.UpdateCmd}.

\begin{table}[hbt]
\caption{}\label{Table.Oper.UpdateCmd}
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание\\
\hline
\hline
INS & $\hex{D6}$: обновление двоичных данных\\
\hline
P1 & Старший байт смещения, с которого будут перезаписываться данные 
(старший бит должен быть равен нулю)\\
\hline
P2 & Младший байт смещения, с которого будут перезаписываться данные \\
\hline
CDF & Записываемые данные \\
\hline 
\hline
RDF &  --- \\
\hline
$\text{SW1} \parallel \text{SW2}$ & 
$\hex{9000}$: данные перезаписаны успешно \\
\cline{2-2}
 & Другое: см. таблицу~\ref{Table.Errors.General} \\
\hline
\end{tabular}
\end{table}

Размер данных, которые нужно записать, определяется компонентом Lс команды 
(см.~\cite{APDU}).

Команда может вызываться в состояниях PS, AS:AT 
при выборе eSign и в состоянии AS:AT при выборе eID.
В состоянии AS:AT команда может вызываться только 
авторизованным терминалом, в сертификате которого
задано право записи в соответствующий элементарный 
файл (см.~\ref{DATA.Access}).

Для обновления элементарных файлов прикладной программы eSign 
требуется предварительная аутентификация по PIN.

Для обновления элементарных файлов прикладной программы eID 
требуется предварительная аутентификация по CAN или PIN.

Файл, в который записываются данные, должен быть предварительно
выбран (см. \ref{Oper.Descr.SelectEF}).
Запись может быть произведена только в те файлы, для которых 
нет ограничений по записи при текущем состоянии КТ. 
При попытке записи в файлы, доступ к которым ограничен, 
должен возвращаться статус $\text{SW1} \parallel\text{SW2} = \hex{6982}$. 

\subsection{Переключение между соединениями}
\label{Oper.Descr.SetCS}

Для переключения между защищенным соединением,
устанавливаемым между КТ и КП после выполнения 
протокола BPACE, и соединением, 
устанавливаемым между КТ и терминалом после выполнения 
протокола BAUTH, используется команда <MSE: Set CS> (аббревиатура от <<Manage 
Security Environment: Set Context Switch>).
Команда определена в таблице~\ref{Table.Oper.SetCSCmd}.

\begin{table}[hbt]
\caption{}\label{Table.Oper.SetCSCmd}
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание \\
\hline
\hline
INS & $\hex{22}$: управление средой безопасности\\ 
\hline
$\text{P1} \parallel\text{P2}$ & $\hex{01A4}$: 
переключиться между соединениями \\
\hline
CDF & 
$\der(\hex{E1}, \der(\hex{81}, X))$, 
где $X$ определяет идентификатор
соединения и принимает значение $\hex{00}$ для
переключения на защищенное соединение <<КП -- КТ>>
и значение $\hex{01}$ для переключения на защищенное
соединение <<терминал -- КТ>>\\ 
\hline 
\hline
RDF &  --- \\
\hline
$\text{SW1} \parallel \text{SW2}$ & 
$\hex{9000}$: переключение между соединениями выполнено успешно \\
\cline{2-2}
 & Другое: см. таблицу~\ref{Table.Errors.General} \\
\hline
\end{tabular}
\end{table}

Команда может вызываться при выборе eID или eSign в состоянии AS.

Команда требует предварительной аутентификации по PIN или PUK.

Переключение между соединениями может понадобиться
при подтверждении (см.~\ref{Oper.Descr.VerifyPIN}), 
изменении (см.~\ref{Oper.Descr.ChangePIN})
или разблокировке (см.~\ref{Oper.Descr.UnblockPIN}) PIN.

После успешного выполнения команды мастер-файл становится выбранным. 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Подтверждение PIN}
\label{Oper.Descr.VerifyPIN}

Для подтверждения PIN используется команда <Verify>. 
Команда определена в таблице~\ref{Table.Oper.VerifyPINCmd}.

\begin{table}[hbt]
\caption{}\label{Table.Oper.VerifyPINCmd}
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание \\
\hline
\hline
INS & $\hex{20}$: проверка данных\\
\hline
$\text{P1} \parallel \text{P2}$ & $\hex{0003}$: 
проверить пароль PIN\\
\hline
CDF & Пароль PIN (6 октетов)\\
\hline 
\hline
RDF &  --- \\
\hline
$\text{SW1} \parallel \text{SW2}$ & $\hex{9000}$: аутентификация успешна\\
\cline{2-2}
 & $\hex{63CX}$: аутентификация прошла с ошибкой, 
значение \texttt{X} содержит количество оставшихся попыток аутентификации (при 
$\texttt{X} = 1$ пароль приостановлен, а при $\texttt{X} = 0$~--- 
заблокирован)\\ 
\cline{2-2}
& $\hex{6984}$: пароль деактивирован \\
\cline{2-2}
 & Другое: см. таблицу~\ref{Table.Errors.General} \\
\hline
\end{tabular}
\end{table}

Команда может вызываться при выборе eSign в состояниях PS и AS:CP.

Команда требует предварительной аутентификации по PIN.

При успешном выполнении команды устанавливается флаг подтверждения PIN. При 
ошибке флаг сбрасывается. 

Вызов команды может потребоваться после сброса флага подтверждения PIN, 
принудительного (см.~\ref{Oper.Descr.VerifyDeauth}) или автоматического,
которое происходит после выработки определенного количества подписей 
(см.~\ref{Oper.Descr.Signature}), генерации пары ключей 
(см.~\ref{Oper.Descr.GenKeys}), изменения пароля PIN 
(см.~\ref{Oper.Descr.ChangePIN}), уничтожения личного ключа 
(см.~\ref{Oper.Descr.Terminate}). 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Проверка дополнительного атрибута}
\label{Oper.Descr.VerifyData}

Для проверки дополнительных атрибутов DocumentValidity, AgeVerification, 
RegionVerification (см.~\ref{DATA.Optional}) используется команда  <Verify>. 
Команда определена в таблице~\ref{Table.Oper.VerifyDataCmd}.

\begin{table}[hbt]
\caption{}\label{Table.Oper.VerifyDataCmd}
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание \\
\hline
\hline
INS & $\hex{20}$: проверка данных\\
\hline
$\text{P1} \parallel \text{P2}$ & $\hex{8000}$: 
проверить дополнительный атрибут\\
\hline
CDF & Закодированный идентификатор дополнительного атрибута 
(см.~\ref{DATA.Optional}). 
Может принимать одно из значений 
\verb|id-DocumentValidity|, \verb|id-AgeVerification| или \verb|id-PlaceVerification| 
(см. приложение~\ref{ASN})\\
\hline 
\hline
RDF &  --- \\
\hline
$\text{SW1} \parallel \text{SW2}$ & $\hex{9000}$: атрибут проверен успешно\\
\cline{2-2}
 & $\hex{6200}$: ошибка при проверке атрибута\\
\cline{2-2}
 & Другое: см. таблицу~\ref{Table.Errors.General} \\
\hline
\end{tabular}
\end{table}

Команда может вызываться при выборе eID в состоянии AS:AT
авторизованным терминалом, в сертификате которого задано право
проверки соответствующего атрибута (см.~\ref{DATA.Access}).  

Команда требует предварительной аутентификации по CAN или PIN.

Установка проверяемых командой данных производится 
при инициализации протокола BAUTH (см.~\ref{Oper.Descr.SetBAUTH}).  

Для команды должен использоваться $\text{CLA}=\hex{84}$ 
(прикладной класс для защищенного соединения без использования цепочки 
команд). 


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Проверка сертификата}
\label{Oper.Descr.VerifyCert}

Для импорта и проверки сертификата при аутентификации терминала 
по протоколу BAUTH используется команда 
<PSO: Verify Certificate> (Perform Security Operation: Verify Certificate).
%
Команда определена в таблице~\ref{Table.Oper.VerifyCertCmd}.

\begin{table}[hbt]
\caption{}\label{Table.Oper.VerifyCertCmd}
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание\\ 
\hline
\hline
INS & $\hex{2A}$: управление средой безопасности \\
\hline
$\text{P1} \parallel \text{P2}$ & $\hex{00BE}$: проверить 
сертификат открытого ключа \\ 
\hline
CDF  & Закодированное значение компонента \verb|certificateBody|, определяющего тело 
облегченного сертификата (см.~\ref{CERTS.Format}).\\
 & Закодированное значение компонента \verb|signature|, определяющего подпись 
облегченного сертификата (см.~\ref{CERTS.Format})\\
\hline 
\hline
RDF &  --- \\
\hline
$\text{SW1} \parallel \text{SW2}$ & $\hex{9000}$: сертификат проверен успешно \\
\cline{2-2}
 & Другое: см. таблицу~\ref{Table.Errors.General} \\
\hline
\end{tabular}
\end{table}

В компоненте CDF команды передаются тело и подпись облегченного сертификата.
Для их передачи может использоваться цепочка из двух команд 
<PSO: Verify Certificate>, первая из которых содержит тело 
облегченного сертификата, а вторая~--- подпись облегченного сертификата.

Для передачи нескольких сертификатов, составляющих маршрут 
сертификации, должен использоваться последовательный 
вызов команд <PSO: Verify Certificate>. 
При этом если какой-либо сертификат передается цепочкой команд, 
то для него должна использоваться своя цепочка.

Открытый ключ, используемый при проверке сертификата после его передачи в
КТ, извлекается из сертификата, который хранится на КТ или который был 
импортирован в КТ предшествующим успешным вызовом 
команды <PSO: Verify Certificate> (см.~\ref{CERTS.Path}).

Команда может вызываться при выборе мастер-файла
в состоянии PS непосредственно после 
инициализации протокола BAUTH (см.~\ref{Oper.Descr.SetBAUTH}).

Команда требует предварительной аутентификации по CAN, PIN или PUK. 
Если аутентификация выполнялась по CAN,
то в сертификате терминала должно быть установлено 
право доступа по паролю CAN (см.~\ref{DATA.Access}).

Если сертификат является недействительным, то должен 
возвращаться статус 
$\text{SW1} \parallel \text{SW2} = \hex{6A80}$.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Проверка флага подтверждения PIN}
\label{Oper.Descr.VerifyAuth}

Для проверки флага подтверждения PIN используется команда <Verify>.
Команда определена в таблице~\ref{Table.Oper.VerifyAuthCmd}.

\begin{table}[hbt]
\caption{}\label{Table.Oper.VerifyAuthCmd}
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание \\
\hline
\hline
INS & $\hex{20}$: проверка данных\\
\hline
$\text{P1} \parallel \text{P2}$ & $\hex{0003}$: проверить 
флаг подтверждения PIN\\
\hline
CDF & --- \\
\hline 
\hline
RDF &  --- \\
\hline
$\text{SW1} \parallel \text{SW2}$ & $\hex{9000}$: 
флаг подтверждения PIN установлен\\
\cline{2-2}
 & Другое: см. таблицу~\ref{Table.Errors.General} \\
\hline
\end{tabular}
\end{table}

Команда может вызываться при выборе eSign в состояниях PS, AS:CP и AS:AT. 

Команда требует предварительной аутентификации по PIN.

Если флаг подтверждения PIN не установлен, то должен 
возвращаться статус $\text{SW1} \parallel \text{SW2} = \hex{6982}$.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Разблокировка PIN}
\label{Oper.Descr.UnblockPIN}

Для разблокировки PIN используется команда <Reset Retry Counter>.
Команда определена в таблице~\ref{Table.Oper.UnblockPINCmd}.

\begin{table}[hbt]
\caption{}\label{Table.Oper.UnblockPINCmd}
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & 	Описание\\
\hline
\hline
INS & $\hex{2С}$: разблокировка PIN\\
\hline
P1 & $\hex{02}$: разблокировать PIN с его изменением\\
\cline{2-2}
P1 & $\hex{03}$: разблокировать PIN без его изменения\\
\hline
P2 & $\hex{00}$: PIN выбран неявно\\
\hline
CDF
& При $\text{P1} = \hex{02}$ новое значение PIN (6 октетов)\\
\cline{2-2}
 & При $\text{P1} = \hex{03}$ не задается\\
% & --- \\
\hline 
\hline
RDF & 	 --- \\
\hline
$\text{SW1}\parallel\text{SW2}$ & $\hex{9000}$: 
разблокировка PIN была выполнена успешно\\
\cline{2-2}
& Другое: произошла ошибка (см. таблицу~\ref{Table.Errors.General}) \\
\hline
\end{tabular}
\end{table}

Команда может вызываться при выборе eSign в состояниях 
PS, AS:CP и при выборе eID в состоянии AS:CP. 
В состоянии AS:CP команда может вызываться только в случае,
если в сертификате авторизованного терминала задано право разблокировать 
пароль PIN (см.~\ref{DATA.Access}).

Команда требует предварительной аутентификации по PUK. 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Разбор токена ключа}
\label{Oper.Descr.Decipher}

Для разбора токена ключа используется 
команда <PSO: Decipher> (Perform Security Operation: Decipher).
Команда определена в таблице~\ref{Table.Oper.DecipherCmd}.

\begin{table}[hbt]
\caption{}\label{Table.Oper.DecipherCmd}
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание\\ 
\hline
\hline
INS & $\hex{2A}$: управление средой безопасности \\
\hline
$\text{P1} \parallel \text{P2}$ & $\hex{8086}$: расшифровать
данные \\ 
\hline
CDF & Объект $I \parallel Y$, где $I$~--- заголовок транспортируемого ключа, 
$Y$~--- токен транспортируемого ключа \\
\hline 
\hline
RDF &  Расшифрованный транспортируемый ключ\\
\hline
$\text{SW1} \parallel \text{SW2}$ & $\hex{9000}$: токен ключа 
разобран успешно\\
\cline{2-2}
& Другое: см. таблицу~\ref{Table.Errors.General} \\
\hline
\end{tabular}
\end{table}

При разборе токена ключа используется алгоритм $\texttt{bign-keytransport}^{-1}$
(см.~\ref{CRYPTO.StdAlg}) со стандартными параметрами СТБ 34.101.45.
%
Эти параметры определяются неявно по уровню стойкости личного ключа,
выбранному при инициализации разбора токена (см.~\ref{Oper.Descr.SetCT}).

Битовая длина транспортируемого ключа, который определяется при разборе токена, 
должна принимать одно из трех значений~--- $k=128$, $k=192$ или $k=256$. 
При этом длина~$k$ не должна быть больше уровня стойкости~$l$ личного ключа, 
используемого для разбора. 
%
Входной токен~$Y$ должен состоять из~$k+2l+128$ битов,
заголовок~$I$ является $128$-битовым.

Команда может вызываться при выборе eSign в состояниях 
PS и AS:AT непосредственно после успешной инициализации 
разбора токена (см.~\ref{Oper.Descr.SetCT}).

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Сброс флага подтверждения PIN}
\label{Oper.Descr.VerifyDeauth}

Для сброса флага подтверждения PIN используется команда <Verify>.
Команда определена в таблице~\ref{Table.Oper.VerifyDeauthCmd}.

\begin{table}[hbt]
\caption{}\label{Table.Oper.VerifyDeauthCmd}
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание \\
\hline
\hline
INS & $\hex{20}$: проверка данных\\
\hline
$\text{P1} \parallel \text{P2}$ & $\hex{FF03}$: сбросить 
флаг подтверждения PIN\\
\hline
CDF & ---  \\
\hline 
\hline
RDF &  --- \\
\hline
$\text{SW1} \parallel \text{SW2}$ & $\hex{9000}$ 
флаг подтверждения PIN сброшен успешно\\
\cline{2-2}
& Другое: см. таблицу~\ref{Table.Errors.General} \\
\hline
\end{tabular}
\end{table}

Команда может вызываться при выборе eSign в состояниях PS, AS:CP и AS:AT.

Команда требует предварительной аутентификации по PIN.

При успешном выполнении команды флаг подтверждения PIN
сбрасывается. При ошибке флаг не изменяется.

Если флаг подтверждения PIN уже сброшен, то должен быть возвращен статус
$\text{SW1} \parallel \text{SW2} = \hex{9000}$.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Чтение данных}
\label{Oper.Descr.Read}

Для чтения данных из элементарных файлов используется команда <Read Binary>.
Команда определена в таблице~\ref{Table.Oper.ReadCmd}.

\begin{table}[hbt]
\caption{}\label{Table.Oper.ReadCmd}
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание \\
\hline
\hline
INS & $\hex{B0}$: чтение двоичных данных \\
\hline
P1 & Старший байт смещения, с которого будут прочитываться данные 
(старший бит должен быть равен нулю)\\
\hline
P2 & Младший байт смещения, с которого будут прочитываться данные\\
\hline
CDF &  --- \\
\hline 
\hline
RDF & 	Прочитанные данные \\
\hline
$\text{SW1} \parallel\text{SW2}$ & 
$\hex{9000}$: данные прочитаны успешно \\
\cline{2-2}
& Другое: см. таблицу~\ref{Table.Errors.General} \\
\hline
\end{tabular}
\end{table}

Размер данных, которые нужно прочитать, определяется компонентом 
Le (см.~\cite{APDU}).

Команда может вызываться в состояниях PS, AS:AT 
для файлов eSign и в состоянии AS:AT для файлов eID.
В состоянии AS:AT команда может вызываться только 
авторизованным терминалом, в сертификате которого
задано право чтения соответствующего файла или группы данных
(см.~\ref{DATA.Access}).

Для чтения элементарных файлов прикладной программы eSign 
требуется предварительная аутентификация по PIN.

Для чтения элементарных файлов прикладной программы eID 
требуется предварительная аутентификация по CAN или PIN.

Элементарный файл, из которого прочитываются данные, должен быть предварительно 
выбран (см.~\ref{Oper.Descr.SelectEF}). Прочитаны могут быть только те данные, 
для которых нет ограничений по чтению при текущем состоянии КТ 
(см.~\ref{DATA.Access}). При попытке чтения данных, доступ к которым ограничен, 
должен возвращаться статус $\text{SW1} \parallel \text{SW2} = \hex{6982}$.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Уничтожение личного ключа}
\label{Oper.Descr.Terminate}

Для уничтожения личного ключа используется команда <Terminate>.
Команда определена в таблице~\ref{Table.Oper.TerminateCmd}.

\begin{table}[ht]
\caption{}\label{Table.Oper.TerminateCmd}
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание\\
\hline
\hline
INS & $\hex{E6}$: уничтожение личного ключа\\
\hline
$\text{P1} \parallel\text{P2}$ & $\hex{2100}$:
использовать идентификатор личного ключа из поля данных\\
\hline
CDF &  $\der(\hex{B6},\der(\hex{84}, X))$,
%$\der(\hex{84}, X)$,  
где $X$ определяет идентификатор личного ключа
(см. таблицу~\ref{Table.Oper.KeyRef})\\ 
\hline 
\hline
RDF & ---  \\
\hline
$\text{SW1} \parallel \text{SW2}$ & 
$\hex{9000}$: ключ уничтожен успешно\\
\cline{2-2}
 & Другое: см. таблицу~\ref{Table.Errors.General}\\
\hline
\end{tabular}
\end{table}

Команда может вызываться при выборе eSign в состояниях 
PS и AS:AT. В состоянии AS:AT команда может вызываться только
авторизованным терминалом, в сертификате которого задано право
уничтожать ключи (см.~\ref{DATA.Access}).
В каждом из состояний могут быть уничтожены только те ключи, которые
были сгенерированы в данном состоянии (см.~\ref{Oper.Descr.GenKeys}).

Команда требует предварительной аутентификации по PIN. 
При вызове команды флаг подтверждения PIN должен быть установлен.

Выполнение команды приводит к сбросу флага подтверждения PIN.
Для установки флага после сброса необходимо либо подтвердить пароль PIN 
(см.~\ref{Oper.Descr.VerifyPIN}), либо повторно выполнить аутентификацию по PIN 
(см.~\ref{Oper.Seq.BPACE}). 

При попытке уничтожить ключ, который не был сгенерирован
или который был уничтожен ранее, должен возвращаться 
статус $\text{SW1} \parallel \text{SW2} = \hex{9000}$.