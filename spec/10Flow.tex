\chapter{Выпуск билета аутентификации}\label{FLOW}

\section{Схема}\label{FLOW.Common}

В настоящем разделе определяется схема взаимодействия ПС, КП, КТ и его
владельца, СИ и его терминала для аутентификации КТ с выдачей ПС билета
аутентификации.
%
Аутентификация и выпуск билета проводятся СИ и терминалом по запросу ПС при 
помощи КП и с согласия владельца.
%
Непосредственную аутентификацию КТ выполняет терминал с помощью протокола BAUTH.
Перед этим КТ проводит парольную аутентификацию владельца (протокол BPACE), а
затем аутентификацию терминала (первая часть BAUTH).

Утверждения, которые приводятся в билете, могут быть известны СИ
(например, утверждения аутентификации) или могут храниться на КТ в виде 
идентификационных атрибутов, и тогда терминалу требуется их получить.
%
Перед передачей атрибутов пользователь дает согласие на передачу, а КТ 
проверяет, что запрос атрибутов подкреплен правами в сертификате 
терминала. Атрибуты пересылаются по защищенному соединению.

Определяемая схема может использоваться для построения систем массовой 
аутентификации. Схема может адаптироваться к нуждам систем в части 
организации пересылок между сторонами, поддержки дополнительных сервисов. 
При адаптации должна сохраняться последовательность криптографических 
операций схемы.

\section{Объекты}\label{FLOW.Obj}

При выпуске билета аутентификации используются следующие объекты:
\begin{itemize}
\item[--]
$\Req_\text{ПС}$~--- запрос аутентификации;
\item[--]
$H_\text{КП}, H_\text{СИ}$~--- хэш-значения $\Req_\text{ПС}$, 
которые вычисляют КП и СИ соответственно;
\item[--]
$\Chart_\text{ПС}$~--- перечень утверждений, запрашиваемых ПС в~$\Req_\text{ПС}$;
\item[--]
$\Chart_\text{В}$~--- перечень идентификационных атрибутов, на предоставление 
которых дает согласие владелец КТ. Перечень $\Chart_\text{В}$ является 
сужением~$\Chart_\text{ПС}$, которое не включает не одобренные владельцем 
необязательные атрибуты.  
%
Перечень кодируется словом прав доступа к прикладной программе eID. Это слово
представляется объектом типа \texttt{CertHAT} (см.~\ref{DATA.Access});
\item[--]
$\Cert(Id_T,Q_T)$~--- сертификат терминала. Неявно сопровождается сертификатом
корневного УЦ  и может явно сопровождаться сертификатом промежуточного УЦ 
(см.~\ref{OBJ.Certs}). Маршрут сертификации определяет слово прав доступа к 
прикладной программе eID (см.~\ref{CERTS.Path}); 
\item[--]
$\Attr_\text{КТ}$~--- идентификационные атрибуты КТ (группы данных и 
дополнительные атрибуты) в соответствии с перечнем~$\Chart_\text{В}$. 
\end{itemize}

\section{Сообщения}\label{FLOW.Msgs}

В таблице~\ref{Table.FLOW.Msgs} схематически представлены сообщения,
которыми обмениваются стороны при выпуске билета аутентификации.

В таблице сообщения вспомогательных протоколов BPACE и BAUTH 
маркируются индексом, в котором указывается 
название протокола. Например, $\text{M1}_\text{BAUTH}$~--- 
это сообщение M1 протокола BAUTH. 
%
Двойная стрелка ($\Rightarrow$) означает пересылку данных по 
защищенному соединению. Сначала это соединение <<КТ~--- КП>>, 
затем соединение <<КТ~--- терминал>>. 

\if0
Хотя КП участвует в продолжении соединения и является 
посредником при передаче по нему сообщений, она не может раскрыть содержимое
сообщений.
\fi

Формат сообщений отправляемых и возвращаемых КТ детализируется в разделе~\ref{CMDS}.

Стороны могут обмениваться дополнительными сообщениями, 
например, характеристиками КТ или параметрами дополнительных идентификационных 
атрибутов. 

\begin{table}[bht]
\caption{Выпуск билета аутентификации: сообщения}\label{Table.FLOW.Msgs}
\addtolength{\tabcolsep}{-1.5pt}
\begin{tabular}{|c|c|c|l|}
\hline
Шаг & Направление & Сообщение & Примечание\\
\hline
%
\hline
1   & $\text{ПС}\rightarrow\text{КП}$ & $\Req_\text{ПС}$ &
$\Req_\text{ПС}=\langle\langle\Chart_\text{ПС}\rangle\rangle$\\
\hline
%
2   & $\text{КП}\rightarrow\text{СИ}$ & 
$\langle\langle\Req_\text{ПС},\Chart_\text{В}\rangle\rangle$ &\\
\hline
%
3   & $\text{КП}\rightarrow\text{КТ}$ & 
$\langle\langle\addendum{\text{M1}_\text{BPACE}}\rangle\rangle$ &
$\addendum{\hello_\text{КП}=\langle\langle\Chart_\text{В}\rangle\rangle}$\\
    & $\text{КТ}\rightarrow\text{КП}$ & 
$\langle\langle\text{M2}_\text{BPACE}\rangle\rangle$ &\\
    & $\text{КП}\rightarrow\text{КТ}$ & 
$\langle\langle\text{M3}_\text{BPACE}\rangle\rangle$ &\\
    & $\text{КТ}\rightarrow\text{КП}$ & 
$\langle\langle\text{M4}_\text{BPACE}\rangle\rangle$ &\\
\hline
%
4   & $\text{СИ}\rightarrow\text{КП}$ & 
$\langle\langle\Cert(Id_\text{Т},Q_\text{Т})\rangle\rangle$ &\\
\hline
%
5   & $\text{КП}\Rightarrow\text{КТ}$ & 
$\langle\langle\text{M0}_\text{BAUTH}\rangle\rangle$ &
$\text{M0}_\text{BAUTH}=\addendum{
  \langle\langle\hello_\text{Т},\Cert(Id_\text{Т},Q_\text{Т})\rangle\rangle}$\\
    & $\text{КТ}\Rightarrow\text{КП}$ & 
$\langle\langle\text{M1}_\text{BAUTH}\rangle\rangle$ &\\
\hline
%
6   & $\text{КП}\rightarrow\text{СИ}\rightarrow\text{Т}$ &
$\langle\langle\text{M1}_\text{BAUTH}\rangle\rangle$ &\\
    & $\text{Т}\rightarrow\text{СИ}\rightarrow\text{КП}\Rightarrow\text{КТ}$ & 
$\langle\langle\text{M2}_\text{BAUTH}\rangle\rangle$ &\\
    & $\text{КТ}\Rightarrow\text{КП}\rightarrow\text{СИ}\rightarrow\text{Т}$ & 
$\langle\langle\text{M3}_\text{BAUTH}\rangle\rangle$ &\\
\hline
%
7   & $\text{Т}\Rightarrow\text{КТ}$ &
$\langle\langle\Chart_\text{В}\rangle\rangle$ & По частям, через CИ и КП\\
    & $\text{КТ}\Rightarrow\text{Т}$ & 
$\langle\langle\Attr_\text{КТ}\rangle\rangle$ & По частям, через КП и СИ\\
\hline
%
8   & $\text{СИ}\rightarrow\text{ПС}$ &
Билет & 
$\text{билет}=\langle\langle\Attr_\text{КТ}\rangle\rangle$\\
\hline
\end{tabular}
\addtolength{\tabcolsep}{1.5pt}
\end{table}

\section{Шаги}\label{FLOW.Steps}

Выпуск билета аутентификации выполняется за 8 шагов, определяемых
ниже. При ошибке на любом шаге, в том числе при нарушении условий проверок,
выпуск билета прекращается. Правила обработки ошибок, в том числе правила
информирования сторон об ошибке, в настоящем стандарте не определяются. 

\vskip3pt
{\bf Шаг 1~--- отправка запроса аутентификации}.
%
ПС отправляет КП запрос аутентификации~$\Req_\text{ПС}$. 
Этот запрос содержит перечень~$\Chart_\text{ПС}$.

Запрос должен быть волатильным: запросы одинакового содержания,
выпущенные в разные моменты времени, должны отличаться. Для обеспечения 
волатильности в запрос может включаться отметка времени или уникальная 
синхропосылка.

Может требоваться, чтобы ПС подписывала запрос или включала в него аттестаты,
подтверждающие права доступа к запрошенным идентификационным атрибутам. В таких
случаях проверка запроса включает проверку подписи и прав доступа.

\vskip3pt
{\bf Шаг 2~--- обработка запроса аутентификации}.
%
КП получает запрос~$\Req_\text{ПС}$, проверяет его,
выделяет в запросе перечень $\Chart_\text{ПС}$.
%
Этот перечень КП согласует с владельцем КТ.
%
Владелец выбирает устраивающие его пункты~$\Chart_\text{ПС}$, 
в результате чего формируется перечень~$\Chart_\text{В}$.

Затем КП вычисляет хэш-значение $H_\text{КП}=\texttt{belt-hash}(\Req_\text{ПС})$ 
и отправляет СИ запрос~$\Req_\text{ПС}$ вместе с перечнем~$\Chart_\text{В}$. 

СИ может быть заранее задана, либо КП может выбрать СИ из списка с участием 
владельца КП. Список подходящих СИ может быть дан в~$\Req_\texttt{ПС}$.

\vskip3pt
{\bf Шаг 3~--- парольная аутентификация}.
%
КП и КТ выполняют протокол BPACE и формируют общий ключ 
$K_0$. Пароль протокола (PIN или CAN) передает КП владелец КТ. 
В качестве приветственного сообщения $\hello_\text{КП}$ протокола BPACE
используется перечень~\addendum{$\Chart_\text{В}$ и возможно другие данные}. 
КТ должен сохранить $\Chart_\text{В}$ для дальнейшего использования.

КП и КТ создают защищенное соединение на ключе $K_0$.

\vskip3pt
{\bf Шаг 4~--- выбор терминала}.
%
СИ получает запрос $\Req_\text{ПС}$ и перечень $\Chart_\text{В}$.
%
СИ проверяет присланный запрос, выделяет в нем перечень 
$\Chart_\text{ПС}$ и проверяет его соответствие \addendum{$\Chart_\text{В}$}. 

СИ выбирает терминал, права доступа которого позволяют запрашивать 
идентификационные атрибуты в соответствии с перечнем \addendum{$\Chart_\text{В}$}.
%
СИ вычисляет хэш-значение $H_\text{СИ}=\texttt{belt-hash}(\Req_\text{ПС})$
и передает его терминалу вместе с~$\Chart_\text{В}$.

СИ отправляет КП сертификат $\Cert(Id_T,Q_T)$ выбранного терминала 
вместе с маршрутом сертификации.

\vskip3pt
{\bf Шаг 5~--- начало BAUTH}.
%
КП получает от СИ сертификат терминала.
%
КП начинает выполнение протокола BAUTH от имени терминала, 
отправляя КТ сертификат~$\Cert(Id_\text{Т}, Q_\text{Т})$ 
и, при наличии, сертификат промежуточного УЦ 
как часть сообщения~$\text{M0}_\text{BAUTH}$.

КТ проверяет полученные сертификаты и строит по маршруту сертификации 
слово прав доступа терминала к прикладной программе eID (см.~\ref{CERTS.Path}). 
%
КТ проверяет, что терминал имеет доступ ко всем атрибутам из перечня 
$\Chart_\text{В}$, полученного на шаге 3. 

КП отправляет КТ приветственное сообщение~$\hello_\text{Т}$ 
как часть сообщения $\text{M0}_\text{BAUTH}$. 
%
\addendum{В $\hello_\text{Т}$ указывается хэш-значение $H_\text{СИ}$ ($H_\text{КП}$
на стороне КП), перечень~$\Chart_\text{В}$ и возможно другие данные.}

КТ продолжает выполнение протокола BAUTH, обрабатывая~$\hello_\text{Т}$.
КТ формирует и отправляет КП сообщение $\text{M1}_\text{BAUTH}$ с пустым 
приветственным сообщением $\hello_\text{КТ}$. 

Обмен сообщениями между КТ и КП идет по защищенному соединению,
открытому на шаге 3.

КП формирует и отправляет СИ сообщение $\text{M1}_\text{BAUTH}$.

\vskip3pt
{\bf Шаг 6~--- завершение BAUTH}.
%
СИ получает сообщение $\text{M1}_\text{BAUTH}$ и передает его терминалу.

Терминал и КТ завершают выполнение протокола BAUTH (обмениваясь сообщениями 
$\text{M2}_\text{BAUTH}$ и $\text{M3}_\text{BAUTH}$) и формируют общий ключ $K_0$. 
Протокол выполняется при посредничестве СИ и КП. СИ передает КП команды 
терминала, КП пересылает их КТ и возвращает полученные ответы СИ с последующей 
передачей терминалу.

Терминал и КТ создают защищенное соединение на ключе $K_0$. При этом КТ 
переключается на новое соединение с предыдущего защищенного соединения с КП.

\vskip3pt
{\bf Шаг 7~--- чтение атрибутов}.
%
Терминал отправляет, а КТ получает запросы на чтение 
идентификационных атрибутов из перечня~$\Chart_\text{В}$. 
%
КТ проверяет, что запросы терминала соответствуют перечню, 
полученному на шаге~$3$ от КП, и возвращает запрошенные атрибуты.
Терминал объединяет атрибуты в объект~$\Attr_\text{КТ}$.

Взаимодействие терминала и КТ идет по защищенному соединению
при посредничестве СИ и КП.

\vskip6pt
\begin{note}
Примечание 1~-- 
Защищенное соединение между КТ и терминалом может поддерживаться 
определенное время после аутентификации, например, для выполнения 
дополнительных криптографических операций. 
\end{note}

\vskip3pt
{\bf Шаг 8~--- выпуск билета аутентификации}.
%
Терминал передает СИ сформированный объект~$\Attr_\text{КТ}$.
СИ оформляет билет аутентификации и передает его ПС.

\vskip6pt
\begin{note}
Примечание 2~-- 
Отсутствие запрашиваемого атрибута не является ошибкой, 
если этот атрибут не является обязательным. При отсутствии 
необязательного атрибута СИ может пометить его 
в билете как <<отсутствующий на КТ>>. 
\end{note}
