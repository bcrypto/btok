\chapter{Объекты}\label{OBJ}

\section{Генератор случайных или псевдослучайных чисел}\label{OBJ.RNG}

В состав КТ должен входить физический генератор случайных чисел.
Генератор должен удовлетворять требованиям СТБ 34.101.27 или другого 
профильного ТНПА. Генератор должен использоваться для создания личных и 
секретных ключей, может использоваться для создания синхропосылок. 

Вместо генератора случайных чисел может применяться его аналог~--- алгоритм 
генерации псевдослучайных чисел, определенный в СТБ 34.101.47 или в другом 
ТНПА. Входные данные алгоритма генерации должны включать долговременный 
секретный ключ и уникальную синхропосылку.
%
Уровень стойкости алгоритмов, в которых планируется использовать 
генерируемые ключи, не должен превышать битовую длину ключа алгоритма генерации.

\section{Таймер}\label{OBJ.Date}

Для определения текущей даты на КТ должен устанавливаться аппаратный таймер, 
либо если таймер поддержать нельзя, то текущая дата должна 
приближенно оцениваться по реквизитам входящих сертификатов или по другим 
данным, передаваемым на КТ от терминала. Например, текущая дата всегда позже 
даты выпуска очередного сертификата терминала, признанного КТ действительным.

При отсутствии аппаратного таймера оценка текущей даты должна устанавливаться 
при выпуске КТ в обращение равной дате выпуска. 

\section{Пароли}\label{OBJ.PWD}

КТ должен поддерживать три пароля~--- PIN, CAN, PUK.
Пароли используются в протоколе BPACE (см.~\ref{CRYPTO.BPACE})
и являются общими для всех прикладных программ КТ.
%
Пароли записываются на КТ при выпуске токена в обращение. 
Пароли PIN и PUK конфиденциально передаются владельцу, 
CAN передается в открытом виде.

Пароль PIN (от Personal Identification Number)
представляет собой случайное число из 6 десятичных цифр,
известное только владельцу КТ. Используется для контроля доступа к данным и 
прикладным программам КТ. Может быть изменен владельцем в процессе
эксплуатации КТ после ввода верного действующего PIN.

PIN снабжается счетчиком попыток, который первоначально равен 3. При 
неверном вводе PIN счетчик уменьшается на 1. Если счетчик достигает 
значения 1, то PIN приостанавливается и далее требуется ввести CAN. 
Ввод CAN не изменяет счетчик. При верном CAN пароль PIN возобновляется~--- 
его снова можно ввести. При неверном CAN доступ к КТ временно блокируется. 
Если счетчик попыток достигает значения 0, то блокируется PIN. 
%
При вводе верного PIN счетчик попыток возвращается к значению~$3$.

PIN может быть разблокирован после ввода верного PUK. Однако если при 
заблокированном PIN пароль PUK вводится неверно 10 раз, то PIN блокируется 
навсегда.
%
При успешной разблокировке PIN счетчик попыток возвращается к значению~$3$. 

PIN может быть деактивирован и повторно активирован с помощью специальных команд.
Для деактивации требуется предъявить верный PIN или PUK, 
для активации~--- верный PUK. Сразу после выпуска токена PIN активирован. 
При деактивации PIN доступ к операциям и данным, требующим аутентификации по 
PIN, запрещен. В том числе запрещена аутентификация по PIN, разблокировка PIN.
Деактивация и повторная активация PIN не изменяют ни статус его блокировки, 
ни счетчик попыток. 

Пароль CAN (от Card Access Number) представляет собой число из 6 десятичных 
цифр, которое не может быть вычислено на основании общей информации о КТ 
(например, серийном номере) или его владельце. Может быть напечатан на корпусе 
КТ или указан в сопроводительных документах. 

Пароль CAN не может быть заблокирован или изменен. Он используется для защиты 
от атак типа <<отказ в обслуживании>>. Защита состоит в требовании ввести CAN перед 
последней проверкой PIN. Дополнительно CAN может использоваться для 
получения доступа к функциям и данным прикладной программы eID 
авторизованным терминалом, т.~е. терминалом, который был успешно 
аутентифицирован с помощью протокола BAUTH (см.~\ref{CRYPTO.BAUTH}) и в 
сертификате которого установлено соответствующее право (см.~\ref{DATA.Access}). 

Пароль PUK (от PIN Unlock Key) представляет собой случайное число из 10 
десятичных цифр, известное только владельцу КТ. PUK не может быть заблокирован 
или изменен. Используется для разблокировки PIN. Дополнительно может использоваться 
для деактивации и активации PIN.

После ввода неверного CAN или PUK следует временно заблокировать КТ не менее 
чем на 1~с. Для контроля времени блокировки следует использовать аппаратный 
таймер либо организовать вычисления требуемой продолжительности.

При передаче в команды КТ пароли PIN, CAN и PUK представляются строками 
октетов, в которых октет~$\hex{30}$ кодирует цифру~$0$ пароля, 
октет~$\hex{31}$~--- цифру~$1$, \ldots, октет~$\hex{39}$~--- цифру~$9$. 

\section{Личные ключи}\label{OBJ.Keys}

На КТ обязательно хранится личный ключ КТ, который используется 
для аутентификации КТ перед терминалом. Ключ устанавливается при выпуске
КТ в обращение вместе с сертификатом соответствующего открытого ключа. 
Процедуры выпуска КТ должны гарантировать, что ключ сохраняется исключительно 
в пределах криптографической границы токена. К личному ключу КТ можно 
обратиться только косвенно, через выполнение протокола аутентификации. Ключ не 
может быть прочитан с КТ или изменен. 

Дополнительно на КТ могут храниться личные ключи, 
которые используются в прикладной программе eSign для выработки 
подписи и (или) разбора токена ключа. Личные ключи eSign генерируются самим КТ 
при выпуске в обращение или эксплуатации. Личный ключ не может быть прочитан с КТ, 
но может быть уничтожен или сгенерирован заново. Ключ, сгенерированный в 
определенном режиме (базовом или терминальном), может использоваться только в 
этом режиме. Личный ключ генерируется вместе с открытым.

Предусмотрены 6 личных ключей eSign, которым назначены идентификаторы 
$\hex{01}$, $\hex{02}$, $\hex{03}$, $\hex{11}$, $\hex{12}$, $\hex{13}$.
%
Идентификатор должен использоваться для выбора определенного личного ключа 
перед выполнением криптографической операции с ним.
%
Первые 3 идентификатора соответствуют базовому режиму, последние 3~--- 
терминальному. Второй символ идентификатора кодирует уровень стойкости
алгоритмов СТБ 34.101.45: $\ell=128$ кодируется единицей, 
$\ell=192$~--- двойкой и~$\ell=256$~--- тройкой.

Определенный в СТБ 34.101.21 программный интерфейс Cryptoki должен быть
следующим образом настроен на работу с личными ключами eSign:
\begin{enumerate}
\item
Должны действовать соглашения СТБ 34.101.78.
\item
Атрибут \verb|CKA_ID| должен быть одним из 6 указанных выше идентификаторов.
\item
При генерации ключей (механизм \verb|CKM_EC_KEY_PAIR_GEN|) уровень стойкости, 
определяемый атрибутом~\verb|CKA_ID|, должен соответствовать параметрам 
эллиптической кривой, указываемым в атрибуте~\verb|CKA_EC_PARAMS| открытого 
ключа.
\item
Атрибут~\verb|CKA_SENSITIVE| должен принимать значение~\verb|CK_TRUE|,
и это значение не может изменяться.
\item
Атрибут~\verb|CKA_EXTRACTABLE| должен принимать значение~\verb|CK_FALSE|,
и это значение не может изменяться.
\item
Атрибуты~\verb|CKA_SIGN|, \verb|CKA_UNWRAP| личного ключа и 
атрибуты~\verb|CKA_VERIFY|, \verb|CKA_WRAP| открытого ключа должны принимать 
значение~\verb|CK_TRUE|.
\item
Атрибут~\verb|CKA_ALLOWED_MECHANISMS| должен включать механизм~\verb|CKM_BIGN_TSP|,
а также механизм~\verb|CKM_BIGN_HBELT| при уровне стойкости~$\ell=128$ или
механизм~\verb|CKM_BIGN_BASH| при уровне стойкости~$\ell=192$ и $\ell=256$.
\end{enumerate}

\section{Сертификаты}\label{OBJ.Certs}

Открытый ключ~$Q$ стороны с идентификационными данными~$Id$ распространяется в 
форме сертификата~$\Cert(Id,Q)$. 
%
Сертификат представляет собой объект вида~$\llangle Id,Q\rrangle$,
который связывает идентификационные данные с открытым ключом и, косвенно, личным 
ключом стороны.
%
Связывание выполняет УЦ, подписывая данные сертификата на своем личном ключе. 
Соответствующий открытый ключ УЦ также распространяется в форме сертификата,
который выпускается либо вышестоящим УЦ, либо является корневым (самоподписанным).
%
В целом образуется маршрут сертификации~--- цепочка, которая начинается 
корневым сертификатом и заканчивается~$\Cert(Id,Q)$.

При выпуске КТ в обращение на него записывается сертификат КТ, представляющий
личный ключ токена. На КТ записывается также один или несколько корневых 
сертификатов, которые будут использоваться при аутентификации терминала. 

В процессе аутентификации терминал предъявляет свой маршрут сертификации
без первого (корневого) сертификата. КТ проверяет маршрут, в том числе проверяет,
что недостающий корневой сертификат был записан на КТ.
%
В ответ КТ отправляет терминалу свой сертификат. Терминал самостоятельно
восстанавливает маршрут сертификации КТ и после этого проверяет его.

Чтобы уменьшить объем пересылаемых данных и упростить проверку сертификатов, 
они делаются облегченными относительно стандартных сертификатов, определенных 
в СТБ 34.101.19. Формат облегченных сертификатов определен в разделе~\ref{CERTS}. 
Там же определены правила проверки маршрутов сертификации. 

В настоящем стандарте требуется, чтобы длина маршрута сертификации 
равнялась 2 или 3. Другими словами, облегченные сертификаты КТ и терминалов 
должны выпускаться либо непосредственно корневым УЦ, либо промежуточным УЦ, 
подчиненным корневому. 

УЦ, выпускающие облегченные сертификаты, должны снабжаться уникальными номерами
из трех десятичных цифр. УЦ с определенным номером должен использовать только
одну пару ключей (личный и открытый).

Дополнительно на КТ могут записываться сертификаты, представляющие личные ключи 
eSign. Сертификаты eSign являются стандартными, их содержание и формат 
определены в СТБ 34.101.19. Сертификаты должны соответствовать дополнительным 
требованиям, установленным в СТБ 34.101.78 для роли <<Физические лица>>. 
%
В приложении~\ref{FILES} даны рекомендации по хранению сертификатов eSign
в пределах криптографической границы КТ.

\section{Объект \texttt{Name}}\label{OBJ.Name}

При формировании сертификата eSign готовится запрос, в который включаются 
специальным образом отформатированные идентификационные данные. Формат 
определяется типом \texttt{Name}, заданным в СТБ 34.101.19. Должны применяться 
уточнения формата, установленные в СТБ 34.101.78. 

Объект \texttt{Name} готовится терминалом по прочитанным идентификационным 
данным, или объект записывается на КТ в процессе выпуска токена в 
обращение или в процессе эксплуатации. В приложении~\ref{FILES} даны 
рекомендации по хранению объекта в пределах криптографической границы КТ.

\section{Прикладная программа eID}\label{OBJ.eID}

Прикладная программа eID предназначена для управления идентификационными
атрибутами владельца КТ со стороны терминала, представляющего некоторую
информационную систему.
%
Управление атрибутами осуществляется в соответствии с правами,
установленными владельцем КТ, и правами, заданными в маршруте сертификации
терминала (см.~\ref{CERTS.Path}).
%
Атрибуты передаются по защищенному соединению и таким образом обеспечивается 
их конфиденциальность, контролируется целостность и подлинность. 

Программа eID может использоваться только в терминальном режиме
после успешной аутентификации терминала. 

Программе назначается идентификатор \verb|id-eID|, определенный в
приложении~\ref{ASN}. В приложении~\ref{FILES} даны рекомендации по хранению
объектов eID в пределах криптографической границы КТ.

\section{Прикладная программа eSign}\label{OBJ.eSign}

Прикладная программа eSign организует работу с криптографическими 
алгоритмами СТБ 34.101.45. 
%
Программа обеспечивает генерацию личных и открытых 
ключей, управление соответствующими сертификатами, 
выработку подписи и разбор токена ключа.
%
С помощью последовательностей команд eSign организуются сложные макрооперации,  
например, процесс выпуска сертификатов открытых ключей алгоритмов 
ЭЦП/транспорта ключа.

Программа eSign может использоваться в базовом режиме 
после успешной аутентификации владельца либо в терминальном режиме 
после успешной аутентификации терминала (требуется предварительная 
аутентификация владельца). 

Для выполнения некоторых команд eSign требуется согласие владельца КТ. 
Владелец выражает согласие, подтверждая знание PIN. Программа eSign должна 
поддерживать флаг подтверждения PIN.
%
Флаг устанавливается после успешной аутентификации владельца по паролю PIN, а 
также при последующем предъявлении PIN по защищенному соединению.  
%
Флаг сбрасывается после генерации и уничтожения ключей, выработки определенного 
числа ЭЦП, изменения PIN и других операций.

Программе eSign назначается идентификатор \verb|id-eSign|, 
определенный в приложении~\ref{ASN}. В приложении~\ref{FILES}
даны рекомендации по хранению объектов eSign в пределах криптографической 
границы КТ.




